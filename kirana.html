<script>
  let orderItems = [];
  let editIndex = -1;

  window.onload = function () {
    document.getElementById("custName").value = localStorage.getItem("custName") || "";
    document.getElementById("custMobile").value = localStorage.getItem("custMobile") || "";
    document.getElementById("custAddress").value = localStorage.getItem("custAddress") || "";
    document.getElementById("custArea").value = localStorage.getItem("custArea") || "";
  };

  function addItem() {
    const name = document.getElementById("itemName").value.trim();
    const qty = document.getElementById("itemQty").value.trim();
    const unit = document.getElementById("itemUnit").value;

    if (!name || !qty) {
      alert("कृपया आइटम और मात्रा भरें");
      return;
    }

    const fullItem = { name, qty, unit };

    if (editIndex === -1) {
      orderItems.push(fullItem);
    } else {
      orderItems[editIndex] = fullItem;
      editIndex = -1;
    }

    document.getElementById("itemName").value = "";
    document.getElementById("itemQty").value = "";
    renderList();
  }

  function renderList() {
    const ul = document.getElementById("orderList");
    ul.innerHTML = "";

    orderItems.forEach((item, i) => {
      const li = document.createElement("li");
      li.className = "item-row";

      const span = document.createElement("span");
      span.textContent = `${i + 1}. ${item.name} - ${item.qty} ${item.unit}`;

      const actions = document.createElement("div");
      actions.className = "item-actions";

      const editBtn = document.createElement("button");
      editBtn.textContent = "✏️ Edit";
      editBtn.onclick = () => editItem(i);

      const delBtn = document.createElement("button");
      delBtn.textContent = "❌ Delete";
      delBtn.onclick = () => deleteItem(i);

      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      li.appendChild(span);
      li.appendChild(actions);
      ul.appendChild(li);
    });
  }

  function editItem(index) {
    const item = orderItems[index];
    document.getElementById("itemName").value = item.name;
    document.getElementById("itemQty").value = item.qty;
    document.getElementById("itemUnit").value = item.unit;
    editIndex = index;
  }

  function deleteItem(index) {
    orderItems.splice(index, 1);
    renderList();
  }

  function sendToTelegram(message) {
    const botToken = "7729928604:AAETN1ikbhwHTMSK1ngV3nR0UfSGEVb-z2r4";
    const chatId = "6798434092";
    const url = `https://api.telegram.org/bot${botToken}/sendMessage`;

    fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        chat_id: chatId,
        text: message
      })
    }).then(res => {
      console.log("✅ Telegram message sent");
    }).catch(err => {
      console.error("❌ Telegram Error:", err);
    });
  }

  function sendWhatsApp() {
    const name = document.getElementById("custName").value.trim();
    const mobile = document.getElementById("custMobile").value.trim();
    const address = document.getElementById("custAddress").value.trim();
    const area = document.getElementById("custArea").value.trim();

    if (!name || !mobile || !address || !area || orderItems.length === 0) {
      alert("कृपया सभी जानकारी भरें और कम से कम एक आइटम जोड़ें।");
      return;
    }

    localStorage.setItem("custName", name);
    localStorage.setItem("custMobile", mobile);
    localStorage.setItem("custAddress", address);
    localStorage.setItem("custArea", area);

    const itemsText = orderItems.map((item, i) =>
      `${i + 1}. ${item.name} - ${item.qty} ${item.unit}`
    ).join("\n");

    const message = `🛒 *VIP किराना ऑर्डर*\n👤 नाम: ${name}\n📱 मोबाइल: ${mobile}\n🏠 पता: ${address}\n📍 एरिया: ${area}\n\n🧾 ऑर्डर:\n${itemsText}\n🕒 ${new Date().toLocaleString()}`;

    // WhatsApp
    const whatsappNumber = "916351598832";
    const url = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
    window.open(url, "_blank");

    // Telegram
    sendToTelegram(message);

    // Google Sheet
    const sheetData = {
      Name: name,
      Mobile: mobile,
      Address: address,
      Area: area,
      Items: itemsText,
      Time: new Date().toLocaleString()
    };

    fetch("https://api.sheetbest.com/sheets/a4f9e349-0a8f-4c9b-bdc1-ec738c555880", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(sheetData)
    }).then(res => console.log("✅ Sheet Updated"));
  }
</script>
